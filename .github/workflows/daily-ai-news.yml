name: Daily AI News Automation - Optimized

on:
  schedule:
    # Run at 11:30 PM IST daily (6:00 PM UTC)
    - cron: "0 18 * * *"
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  send-ai-news:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # 15-minute timeout for optimized version
    
    steps:
      - name: ğŸš€ Trigger AI News Automation
        id: trigger
        run: |
          echo "ğŸ¤– Starting Daily AI News Automation"
          echo "ğŸ“… Scheduled for 11:30 PM IST (6:00 PM UTC)"
          echo "â° Execution started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          # Single request with extended timeout for optimized function
          echo "ğŸ“¡ Sending request to Vercel endpoint..."
          
          response=$(curl -s -w "\nHTTP_STATUS:%{http_code}\nTIME_TOTAL:%{time_total}" \
            --connect-timeout 30 \
            --max-time 300 \
            --retry 2 \
            --retry-delay 30 \
            -H "User-Agent: GitHub-Actions-Daily-AI-News-Optimized" \
            -X GET \
            "https://ai-news-automation.vercel.app/api/index")
          
          echo "ğŸ“Š Full Response:"
          echo "$response"
          echo ""
          
          # Extract status code and timing
          http_code=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2 | tr -d ' ')
          time_total=$(echo "$response" | grep "TIME_TOTAL:" | cut -d: -f2 | tr -d ' ')
          
          echo "ğŸ“ˆ Status Code: $http_code"
          echo "â±ï¸  Total Time: ${time_total}s"
          
          # Check for success
          if [ "$http_code" = "200" ]; then
            echo "âœ… SUCCESS! AI News automation completed successfully"
            echo "ğŸ“§ Daily email should be delivered shortly"
            echo "ğŸ¯ Function executed in ${time_total}s"
            
            # Log success details
            echo "success=true" >> $GITHUB_OUTPUT
            echo "execution_time=${time_total}" >> $GITHUB_OUTPUT
            echo "status_code=200" >> $GITHUB_OUTPUT
            
          else
            echo "âŒ FAILED with HTTP status: $http_code"
            echo "âš ï¸  This may be a timeout - check if email was still sent"
            echo "ğŸ” Check Vercel function logs for details"
            
            # Log failure details
            echo "success=false" >> $GITHUB_OUTPUT
            echo "status_code=${http_code}" >> $GITHUB_OUTPUT
            
            exit 1
          fi

      - name: ğŸ“Š Log Execution Summary
        if: always()
        run: |
          echo "ğŸ“‹ EXECUTION SUMMARY"
          echo "===================="
          echo "ğŸ•’ Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ“ˆ Status: ${{ steps.trigger.outputs.success == 'true' && 'SUCCESS âœ…' || 'FAILED âŒ' }}"
          echo "â±ï¸  Execution Time: ${{ steps.trigger.outputs.execution_time }}s"
          echo "ğŸ“Š HTTP Status: ${{ steps.trigger.outputs.status_code }}"
          echo ""
          echo "ğŸ’¡ Note: Even if GitHub Actions shows timeout, check your email"
          echo "ğŸ“§ Vercel function may complete successfully despite HTTP timeout"
          
      - name: ğŸ”§ Troubleshooting Info
        if: failure()
        run: |
          echo "ğŸ”§ TROUBLESHOOTING GUIDE"
          echo "========================"
          echo ""
          echo "If this job failed but you received the email:"
          echo "âœ… The automation worked correctly"
          echo "âŒ Only the HTTP request timed out"
          echo ""
          echo "To verify success:"
          echo "1. Check your email inbox for today's AI news digest"
          echo "2. Visit https://ai-news-automation.vercel.app/api/check"
          echo "3. Check Vercel function logs in the dashboard"
          echo ""
          echo "Common causes of timeouts:"
          echo "â€¢ RSS feeds taking longer than usual to respond"
          echo "â€¢ Gemini AI rate limiting or slower responses"
          echo "â€¢ Network latency between GitHub and Vercel"
          echo ""
          echo "ğŸ¯ Target execution time: Under 200 seconds"
